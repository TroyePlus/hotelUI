<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>消费报表</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="lib/layui/css/layui.css"  media="all">
  <!-- 注意：如果你直接复制所有代码到本地，上述css路径需要改成你本地的 -->
  <script src="js/jquery.min.js"></script>
</head>
<body>
  <script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看详情</a>
    <a class="layui-btn layui-btn-xs" lay-event="pay">支付</a>
  </script>

    <div class="demoTable">
        搜索id：
        <div class="layui-inline">
          <input class="layui-input" name="id" id="searchId" autocomplete="off">
        </div>
        <button class="layui-btn" data-type="reload" onclick="searchId()">搜索</button>
      </div>
 
<table class="layui-hide" id="test" lay-filter="test"></table>


              
          
<script src="lib/layui/layui.js" charset="utf-8"></script>
 
<script>
  var cookieUtil={
      /*设置cookie*/
    set:function(name,value){
        var cookie=encodeURIComponent(name)+"="+encodeURIComponent(value);

        document.cookie=cookie;
    },
    /*获取cookie*/
    get:function(name){
        var cookieName=encodeURIComponent(name);
        /*正则表达式获取cookie*/
        var restr="(^| )"+cookieName+"=([^;]*)(;|$)";
        var reg=new RegExp(restr);
        var cookieValue=document.cookie.match(reg)[2];
        /*字符串截取cookie*/
        /*var cookieStart=document.cookie.indexOf(cookieName+“=”);
        var cookieValue=null;
        if(cookieStart>-1){
            var cookieEnd=document.cookie.indexOf(";",cookieStart);
            if(cookieEnd==-1){
                cookieEnd=document.cookie.length;
            }
            cookieValue=decodeURIComponent(document.cookie.substring(cookieStart
            +cookieName.length,cookieEnd));
        }*/
        return cookieValue;
    }
}

  var getCComsumption = function(id){
    $.ajax({
      type: "post",
      url: 'http://localhost:8080/api/form/consumption',
      headers:{
                    Authorization:`Bearer ${cookieUtil.get("Authorization")}`
                },
      xhrFields: {withCredentials: true},
      data: {
        tenantId:id
      },
      success: function (msg) {
          var temp = msg.data;
          layui.use('table', function(){
    var table = layui.table;
    
    //温馨提示：默认由前端自动合计当前行数据。从 layui 2.5.6 开始： 若接口直接返回了合计行数据，则优先读取接口合计行数据。
    //详见：https://www.layui.com/doc/modules/table.html#totalRow
    table.render({
      elem: '#test'
      // ,url:'data.json'//这边写请求数据的路径
      ,toolbar: '#toolbarDemo'
      ,title: '用户数据表'
      ,totalRow: true
      ,cols: [[
        { title:'用户id', templet:function(res){
              var searchId = document.getElementById('searchId').value;
              if(searchId == ''){
                return 1;
              }else{
                return searchId;
              }
        }}
        ,{field:'stayStartTime', title:'开始时间'}
        ,{field:'stayEndTime', title:'结束时间'}
        ,{field:'commodityPrice', title:'消费金额'}
        ,{title:'操作', toolbar: '#barDemo'}
      ]]
      ,page: true,
      data:temp
    });
    
    //工具栏事件
    table.on('tool(test)', function(obj){
      var data = obj.data;
      if(obj.event === 'detail'){
        layer.msg((function (data) {
            var html = "";
            for(let i = 0;i < data.length; i++){
              html += `${data[i].commodityName}:${data[i].quantity}<br/>`
            }
            return html;
        })(data.comsumption), {
          time: 20000, //20s后自动关闭
          btn: ['知道了']
        });
      } else if(obj.event === 'pay'){
        console.log("开发中")
      }
    });
  });
      },
      error: function (msg) {
          console.log('请求报错！');
      }
  });
  }

getCComsumption(1);
</script>
<script>
var searchId = function(){
  var searchId = document.getElementById('searchId').value;
  getCComsumption(searchId);
}
</script>

</body>
</html>