<!DOCTYPE html>
<html class="x-admin-sm">
    
    <head>
        <meta charset="UTF-8">
        <title>欢迎页面-X-admin2.2</title>
        <meta name="renderer" content="webkit">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
        <link rel="stylesheet" href="./css/font.css">
        <link rel="stylesheet" href="./css/xadmin.css">
        <script src="./lib/layui/layui.js" charset="utf-8"></script>
        <script type="text/javascript" src="./js/xadmin.js"></script>
        <script src="js/jquery.min.js"></script>
    </head>
    
    <body>
        <script type="text/html" id="barDemo">
            <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
          </script>
        <div class="x-nav">
            <span class="layui-breadcrumb">
                <a href="">首页</a>
                <a href="">演示</a>
                <a>
                    <cite>导航元素</cite></a>
            </span>
            <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right" onclick="location.reload()" title="刷新">
                <i class="layui-icon layui-icon-refresh" style="line-height:30px"></i>
            </a>
        </div>
        <div class="layui-fluid">
            <div class="layui-row layui-col-space15">
                <div class="layui-col-md12">
                    <div class="layui-card">
                        <div class="layui-card-body ">
                            <!-- <form class="layui-form layui-col-space5" method="POST"> -->
                                    <div class="layui-input-inline layui-show-xs-block">
                                        <input type="text" id="username" name="username" placeholder="用户名" autocomplete="off" class="layui-input"></div>
                                    <div class="layui-input-inline layui-show-xs-block">
                                        <input type="text" id="title" name="title" placeholder="请求标题" autocomplete="off" class="layui-input"></div>
                                <div class="layui-input-inline layui-show-xs-block">
                                    <select id="resType" name="type">
                                        <option>请求类型</option>
                                        <option>Ajax</option>
                                        <option>普通请求</option>
                                    </select>
                                </div>
                                <div class="layui-input-inline layui-show-xs-block">
                                    <button class="layui-btn" lay-filter="sreach" onclick="Search()">
                                        <i class="layui-icon">&#xe615;</i></button>
                                </div>
                            <!-- </form> -->
                        </div>

    <script type="text/html" id="toolbarDemo">
        <div class="layui-btn-container">
            <button class="layui-btn layui-btn-sm" lay-event="DelAll">批量删除</button>
        </div>
        </script>
                        <div class="layui-card-body ">
                            <table id="log" class="layui-hide" lay-filter="test">
                            </table>
                        </div>
                        <div id="test1"></div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script>

var delLog = function(obj){
    $.ajax({
            type: "post",
            url: 'http://localhost:8080/api/system/log/delete',
            xhrFields: {withCredentials: true},
            headers:{
                    Authorization:`Bearer ${cookieUtil.get("Authorization")}`
                },
            data: obj,
            success: function (msg) {
                console.log("成了")
            },
            error: function (msg) {
                console.log('请求报错！');
            }
        });
}


var getLog = function(obj){

layui.use(['laypage','laydate', 'form', 'table'],
        function() {
            var laydate = layui.laydate;
            var laypage = layui.laypage;
            //执行一个laydate实例
            laydate.render({
                elem: '#start' //指定元素
            });

            //执行一个laydate实例
            laydate.render({
                elem: '#end' //指定元素
            });

            var table = layui.table;

            table.render({
                elem: '#log'
                ,toolbar: '#toolbarDemo'
                ,url:'http://localhost:8080/api/system/log/list'
                ,method:'post'
                ,where:obj
                ,title: '财务日报表'
                ,totalRow: true
                ,headers:{
                    Authorization:`Bearer ${cookieUtil.get("Authorization")}`
                }
                ,parseData: function(res){ //res 即为原始返回的数据
                    return {
                    "code": res.code==200?0:400, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": res.count, //解析数据长度
                    "data": res.data //解析数据列表
                    };
                }
                ,cols: [[
                {type: 'checkbox', fixed: 'left'}
                ,{field:'id', title:'id', width:120, fixed: 'left', sort: true}
                ,{field:'userName', title:'用户', width:120}
                ,{field:'createDate', title:'触发时间', width:150 }
                ,{field:'type', title:'请求类型', width:100 }
                ,{field:'title', title:'标题', width:100}
                ,{field:'requestUri', title:'请求路径', width:100,template:function(res){
                    return `<em>${res.requestUri}</em>`
                }}
                ,{field:'httpMethod', title:'请求方法', width:100}
                ,{field:'classMethod', title:'所用类', width:100}
                ,{field:'params', title:'参数', width:100}
                ,{field:'sessionId', title:'token', width:100}
                ,{field:'response', title:'返回', width:100}
                ,{fixed: 'right', title:'操作', toolbar: '#barDemo', width:100}
                ]],
                page:true,
    
  });
  table.on('tool(test)', function(obj){
    var data = obj.data;
    switch(obj.event){
      case 'del':
      layer.confirm('真的删除行么', function(index){
        var deldata = {ids:null}
          deldata.ids = data.id;
        obj.del();
        layer.close(index);
          delLog(deldata);
      });
          
      break;
    }
  });

  table.on('toolbar(test)', function(obj){
    var checkStatus = table.checkStatus(obj.config.id);
    switch(obj.event){
      case 'DelAll':
        var data = checkStatus.data;
        var deldata = {ids:''}
        for(let i = 0;i < data.length;i++){
            deldata.ids += `${data[i].id},`
        }
        // console.log(deldata.ids)
        if (data.length > 0)
     {
         layer.confirm('确定删除吗？',{icon:3, title:'提示信息'}, function (index) {
             $("div.layui-table-body table tbody input[name='layTableCheckbox']:checked").each(function () {
             n = $(this).parents("tbody tr").index(); 
             $("div.layui-table-body table tbody ").find("tr:eq(" + n + ")").remove();
             $("div.layui-table-header table thead div.layui-unselect.layui-form-checkbox").removeClass("layui-form-checked");
           });
            layer.close(index);
            ayer.msg('已删除');
           });
       } else
           {
              layer.msg("请选择需要删除的数据")
           }
        delLog(deldata)
      break;
    };
  });
});

}


getLog({})
    
        /*用户-删除*/
        function member_del(obj, id) {
            layer.confirm('确认要删除吗？',
            function(index) {
                //发异步删除数据
                console.log(index)
                $(obj).parents("tr").remove();
                layer.msg('已删除!', {
                    icon: 1,
                    time: 1000
                });
            });
        }

        function delAll(argument) {

            var data = tableCheck.getData();

            layer.confirm('确认要删除吗？' + data,
            function(index) {
                //捉到所有被选中的，发异步进行删除
                layer.msg('删除成功', {
                    icon: 1
                });
                $(".layui-form-checked").not('.header').parents('tr').remove();
            });
        }
        </script>
        <script>
            var Search = function(){
                var user_name = document.getElementById('username').value;
                var title = document.getElementById('title').value;
                var type = document.getElementById('resType').value;
                console.log(username)
                console.log(title)
                console.log(type)
                if(user_name == ''){
                    user_name = null
                }
                if(title == ''){
                    title = null;
                }
                if(type == "请求类型"){
                    type = null
                }
                console.log({user_name,title,type})
                getLog({user_name,title,type})            }


                var cookieUtil={
      /*设置cookie*/
    set:function(name,value){
        var cookie=encodeURIComponent(name)+"="+encodeURIComponent(value);

        document.cookie=cookie;
    },
    /*获取cookie*/
    get:function(name){
        var cookieName=encodeURIComponent(name)
        /*正则表达式获取cookie*/
        var restr="(^| )"+cookieName+"=([^;]*)(;|$)";
        var reg=new RegExp(restr);
        var cookieValue=document.cookie.match(reg)[2];
        /*字符串截取cookie*/
        /*var cookieStart=document.cookie.indexOf(cookieName+“=”);
        var cookieValue=null;
        if(cookieStart>-1){
            var cookieEnd=document.cookie.indexOf(";",cookieStart);
            if(cookieEnd==-1){
                cookieEnd=document.cookie.length;
            }
            cookieValue=decodeURIComponent(document.cookie.substring(cookieStart
            +cookieName.length,cookieEnd));
        }*/
        return cookieValue;
    }
}
        </script>

</html>